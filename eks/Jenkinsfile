pipeline {
  agent any

  parameters {
    string(
      name: 'EKS_CLUSTER_NAME',
      defaultValue: 'demo-eks',
      description: 'EKS cluster name'
    )
    string(
      name: 'AWS_REGION',
      defaultValue: 'us-east-1',
      description: 'AWS region'
    )
  }

  environment {
    AWS_REGION   = "${params.AWS_REGION}"
    TF_VERSION   = "1.8.5"             // terraform version
    TF_WORKDIR   = "terraform"         // change if your tf files are in another folder
    TF_LOCAL_BIN = ".terraform-bin"    // inside workspace
  }

  stages {

    stage('Install Terraform If Missing') {
      steps {
        sh '''
          set -e

          echo "Checking if Terraform is already installed..."
          if command -v terraform >/dev/null 2>&1; then
            echo "Terraform already installed: $(terraform version | head -n 1)"
          else
            echo "Terraform not found. Installing Terraform ${TF_VERSION} locally in workspace..."

            TF_DIR="${WORKSPACE}/${TF_LOCAL_BIN}"
            mkdir -p "${TF_DIR}"

            echo "Downloading Terraform ${TF_VERSION}..."
            curl -fsSL -o terraform.zip \
              "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"

            unzip -o terraform.zip
            mv terraform "${TF_DIR}/terraform"
            chmod +x "${TF_DIR}/terraform"
            rm -f terraform.zip

            echo "Terraform installed at ${TF_DIR}/terraform"
            "${TF_DIR}/terraform" version
          fi
        '''
      }
    }

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Terraform Init') {
      steps {
        sh '''
          set -e
          export PATH="${WORKSPACE}/${TF_LOCAL_BIN}:$PATH"

          # Decide working directory: prefer TF_WORKDIR if it exists, else workspace root
          WORKDIR="${TF_WORKDIR}"
          if [ ! -d "${WORKDIR}" ]; then
            echo "Directory '${WORKDIR}' not found. Using workspace root instead."
            WORKDIR="."
          fi

          echo "Using Terraform working directory: ${WORKDIR}"
          cd "${WORKDIR}"

          terraform version
          terraform init -input=false
        '''
      }
    }

    stage('Terraform Plan') {
      steps {
        sh '''
          set -e
          export PATH="${WORKSPACE}/${TF_LOCAL_BIN}:$PATH"

          WORKDIR="${TF_WORKDIR}"
          if [ ! -d "${WORKDIR}" ]; then
            echo "Directory '${WORKDIR}' not found. Using workspace root instead."
            WORKDIR="."
          fi

          echo "Using Terraform working directory: ${WORKDIR}"
          cd "${WORKDIR}"

          terraform plan -input=false \
            -var "cluster_name=${EKS_CLUSTER_NAME}" \
            -var "region=${AWS_REGION}"
        '''
      }
    }

    stage('Terraform Apply') {
      steps {
        sh '''
          set -e
          export PATH="${WORKSPACE}/${TF_LOCAL_BIN}:$PATH"

          WORKDIR="${TF_WORKDIR}"
          if [ ! -d "${WORKDIR}" ]; then
            echo "Directory '${WORKDIR}' not found. Using workspace root instead."
            WORKDIR="."
          fi

          echo "Using Terraform working directory: ${WORKDIR}"
          cd "${WORKDIR}"

          terraform apply -input=false -auto-approve \
            -var "cluster_name=${EKS_CLUSTER_NAME}" \
            -var "region=${AWS_REGION}"
        '''
      }
    }

    stage('Show EKS ALB URL') {
      steps {
        sh '''
          set -e
          export PATH="${WORKSPACE}/${TF_LOCAL_BIN}:$PATH"

          WORKDIR="${TF_WORKDIR}"
          if [ ! -d "${WORKDIR}" ]; then
            echo "Directory '${WORKDIR}' not found. Using workspace root instead."
            WORKDIR="."
          fi

          echo "Using Terraform working directory: ${WORKDIR}"
          cd "${WORKDIR}"

          echo "==============================="
          echo "       EKS ALB URL"
          echo "==============================="
          terraform output -raw alb_url 2>/dev/null || terraform output alb_url
          echo "==============================="
        '''
      }
    }
  }
}
