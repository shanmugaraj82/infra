pipeline {
  agent any

  parameters {
    string(
      name: 'EKS_CLUSTER_NAME',
      defaultValue: 'demo-eks',
      description: 'EKS cluster name'
    )
    string(
      name: 'AWS_REGION',
      defaultValue: 'us-east-1',
      description: 'AWS region'
    )
  }

  environment {
    AWS_REGION = "${params.AWS_REGION}"
    TF_VERSION = "1.8.5"   // you can update this anytime
    TF_BIN     = "/usr/local/bin/terraform"
  }

  stages {

    stage('Install Terraform If Missing') {
      steps {
        sh '''
          echo "Checking if Terraform is already installed..."
          if command -v terraform >/dev/null 2>&1; then
            echo "Terraform already installed: $(terraform version)"
          else
            echo "Terraform not found. Installing Terraform ${TF_VERSION} ..."
            
            # Download the Terraform zip
            curl -fsSL -o terraform.zip \
              https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
            
            # Unzip and move to /usr/local/bin
            unzip terraform.zip
            sudo mv terraform ${TF_BIN}
            sudo chmod +x ${TF_BIN}
            
            echo "Terraform installed successfully: $(terraform version)"
          fi
        '''
      }
    }

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Terraform Init') {
      steps {
        sh '''
          cd terraform
          terraform init -input=false
        '''
      }
    }

    stage('Terraform Plan') {
      steps {
        sh '''
          cd terraform
          terraform plan -input=false \
            -var "cluster_name=${EKS_CLUSTER_NAME}" \
            -var "region=${AWS_REGION}"
        '''
      }
    }

    stage('Terraform Apply') {
      steps {
        sh '''
          cd terraform
          terraform apply -input=false -auto-approve \
            -var "cluster_name=${EKS_CLUSTER_NAME}" \
            -var "region=${AWS_REGION}"
        '''
      }
    }

    stage('Show EKS ALB URL') {
      steps {
        sh '''
          cd terraform
          echo "==============================="
          echo "       EKS ALB URL"
          echo "==============================="
          terraform output -raw alb_url 2>/dev/null || terraform output alb_url
          echo "==============================="
        '''
      }
    }
  }
}
