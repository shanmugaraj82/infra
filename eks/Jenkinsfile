pipeline {
  agent any

  parameters {
    string(
      name: 'EKS_CLUSTER_NAME',
      defaultValue: 'demo-eks',
      description: 'EKS cluster name'
    )
    string(
      name: 'AWS_REGION',
      defaultValue: 'us-east-1',
      description: 'AWS region'
    )
  }

  environment {
    AWS_REGION = "${params.AWS_REGION}"
    TF_VERSION = "1.8.5"   // change here if you want another version
  }

  stages {

    stage('Install Terraform If Missing') {
      steps {
        sh '''
          set -e

          echo "Checking if Terraform is already installed..."
          if command -v terraform >/dev/null 2>&1; then
            echo "Terraform already installed: $(terraform version | head -n 1)"
          else
            echo "Terraform not found. Installing Terraform ${TF_VERSION} locally in workspace..."

            # Directory to hold terraform binary in this job's workspace
            TF_DIR="${WORKSPACE}/.terraform-bin"
            mkdir -p "${TF_DIR}"

            # Download Terraform
            curl -fsSL -o terraform.zip \
              "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"

            unzip -o terraform.zip
            mv terraform "${TF_DIR}/terraform"
            chmod +x "${TF_DIR}/terraform"
            rm -f terraform.zip

            echo "Terraform installed at ${TF_DIR}/terraform"
            "${TF_DIR}/terraform" version
          fi
        '''
      }
    }

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Terraform Init') {
      steps {
        sh '''
          set -e
          # Ensure our local terraform bin is in PATH for this step
          export PATH="${WORKSPACE}/.terraform-bin:$PATH"

          cd terraform
          terraform version
          terraform init -input=false
        '''
      }
    }

    stage('Terraform Plan') {
      steps {
        sh '''
          set -e
          export PATH="${WORKSPACE}/.terraform-bin:$PATH"

          cd terraform
          terraform plan -input=false \
            -var "cluster_name=${EKS_CLUSTER_NAME}" \
            -var "region=${AWS_REGION}"
        '''
      }
    }

    stage('Terraform Apply') {
      steps {
        sh '''
          set -e
          export PATH="${WORKSPACE}/.terraform-bin:$PATH"

          cd terraform
          terraform apply -input=false -auto-approve \
            -var "cluster_name=${EKS_CLUSTER_NAME}" \
            -var "region=${AWS_REGION}"
        '''
      }
    }

    stage('Show EKS ALB URL') {
      steps {
        sh '''
          set -e
          export PATH="${WORKSPACE}/.terraform-bin:$PATH"

          cd terraform
          echo "==============================="
          echo "       EKS ALB URL"
          echo "==============================="
          terraform output -raw alb_url 2>/dev/null || terraform output alb_url
          echo "==============================="
        '''
      }
    }
  }
}
