pipeline {
  agent any

  parameters {
    string(
      name: 'EKS_CLUSTER_NAME',
      defaultValue: 'demo-eks',
      description: 'EKS cluster name'
    )
    string(
      name: 'AWS_REGION',
      defaultValue: 'us-east-1',
      description: 'AWS region'
    )
  }

  environment {
    AWS_REGION    = "${params.AWS_REGION}"
    TF_VERSION    = "1.8.5"
    TF_LOCAL_BIN  = ".terraform-bin"
    TF_WORKDIR    = "eks/terraform"   // <- your .tf files live here
    AWS_CREDS_ID  = "aws-jenkins-creds" // <- Jenkins credentials ID
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Debug â€“ Show workspace contents') {
      steps {
        sh '''
          echo "== Workspace =="
          pwd
          echo "== Top-level =="
          ls -la

          echo "== eks/terraform directory =="
          if [ -d "${TF_WORKDIR}" ]; then
            ls -la "${TF_WORKDIR}"
            echo "== .tf files under eks/terraform =="
            find "${TF_WORKDIR}" -maxdepth 2 -name "*.tf" || echo "No .tf files!"
          else
            echo "Directory '${TF_WORKDIR}' does NOT exist!"
          fi
        '''
      }
    }

    stage('Install Terraform If Missing') {
      steps {
        sh '''
          set -e

          echo "Checking if Terraform is already installed..."
          if command -v terraform >/dev/null 2>&1; then
            echo "Terraform already installed: $(terraform version | head -n 1)"
          else
            echo "Terraform not found. Installing Terraform ${TF_VERSION} locally in workspace..."

            TF_DIR="${WORKSPACE}/${TF_LOCAL_BIN}"
            mkdir -p "${TF_DIR}"

            echo "Downloading Terraform ${TF_VERSION}..."
            curl -fsSL -o terraform.zip \
              "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip"

            unzip -o terraform.zip
            mv terraform "${TF_DIR}/terraform"
            chmod +x "${TF_DIR}/terraform"
            rm -f terraform.zip

            echo "Terraform installed at ${TF_DIR}/terraform"
            "${TF_DIR}/terraform" version
          fi
        '''
      }
    }

    stage('Terraform Init') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: "${AWS_CREDS_ID}",
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          sh '''
            set -e
            export PATH="${WORKSPACE}/${TF_LOCAL_BIN}:$PATH"
            export AWS_REGION="${AWS_REGION}"

            echo "Using Terraform working directory: ${TF_WORKDIR}"
            cd "${TF_WORKDIR}"

            terraform version
            terraform init -input=false -upgrade
          '''
        }
      }
    }

    stage('Terraform Plan') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: "${AWS_CREDS_ID}",
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          sh '''
            set -e
            export PATH="${WORKSPACE}/${TF_LOCAL_BIN}:$PATH"
            export AWS_REGION="${AWS_REGION}"

            cd "${TF_WORKDIR}"

            terraform plan -input=false \
              -var "cluster_name=${EKS_CLUSTER_NAME}" \
              -var "region=${AWS_REGION}"
          '''
        }
      }
    }

    stage('Terraform Apply') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: "${AWS_CREDS_ID}",
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          sh '''
            set -e
            export PATH="${WORKSPACE}/${TF_LOCAL_BIN}:$PATH"
            export AWS_REGION="${AWS_REGION}"

            cd "${TF_WORKDIR}"

            terraform apply -input=false -auto-approve \
              -var "cluster_name=${EKS_CLUSTER_NAME}" \
              -var "region=${AWS_REGION}"
          '''
        }
      }
    }

    stage('Show EKS ALB URL') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: "${AWS_CREDS_ID}",
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          sh '''
            set -e
            export PATH="${WORKSPACE}/${TF_LOCAL_BIN}:$PATH"
            export AWS_REGION="${AWS_REGION}"

            cd "${TF_WORKDIR}"

            echo "==============================="
            echo "       EKS ALB URL"
            echo "==============================="
            terraform output -raw alb_url 2>/dev/null || terraform output alb_url
            echo "==============================="
          '''
        }
      }
    }
  }
}
